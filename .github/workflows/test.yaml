name: Run Tests

on:
  push:
    branches:
      - master
      - main
  pull_request:
  workflow_dispatch:

jobs:
  # Supported versions is rather complex:
  #
  # ubuntu-18.04: OTP_VERSION=17.0 - 25.3
  # ubuntu-20.04: OTP_VERSION=21.0 - 27
  # ubuntu-22.04: OTP_VERSION=24.2 - 27
  # ubuntu-24.04: OTP_VERSION=24.3 - 27
  #
  # OTP-26) REBAR3_VERSION="3.22.1"
  # OTP-25) REBAR3_VERSION="3.22.1"
  # OTP-24) REBAR3_VERSION="3.16.1"
  # OTP-23) REBAR3_VERSION="3.16.1"
  # OTP-22) REBAR3_VERSION="3.16.1"
  # OTP-21) REBAR3_VERSION="3.15.2"
  # OTP-20) REBAR3_VERSION="3.15.2"
  # OTP-19) REBAR3_VERSION="3.15.2"
  # OTP-18) REBAR3_VERSION="3.11.1"
  # OTP-17) REBAR3_VERSION="3.10.0"

  test:
    runs-on: ubuntu-20.04
    name: OTP ${{matrix.version.otp}}
    env:
      emacs: 27.1
    strategy:
      matrix:
        version:
          - otp: "22.3.4.9"
            rebar3: "3.16.1"
          - otp: "23.3.4.5"
            rebar3: "3.16.1"
          - otp: "24.3.3"
            rebar3: "3.16.1"
          - otp: "25.3.3"
            rebar3: "3.22.1"
          - otp: "26.5.3"
            rebar3: "3.22.1"
          - otp: "27.3.3"
            rebar3: "3.22.1"
    steps:
      - name: Install Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{env.emacs}}

      - name: Install Erlang
        id: install_erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{matrix.version.otp}}
          rebar3-version: ${{matrix.version.rebar3}}
          install-hex: false

      - name: Add Erlang to Path
        run: |
          echo "ERL_PATH=/usr/lib/erlang" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Compile
        run: make

      - name: Test
        run: make test
